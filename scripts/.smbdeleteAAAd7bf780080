#!/usr/bin/env bash
# 一次性配置：把本机 SSH 公钥拷到两台 Windows 服务器，实现免密登录
# 每台服务器只需输入一次密码，之后 fetch_boot_to_sd.sh 就不再要密码

set -e

USER="ws"
SERVERS=("192.168.7.88" "192.168.7.77")
PUBKEY="${HOME}/.ssh/id_ed25519.pub"

if [[ ! -f "$PUBKEY" ]]; then
  echo "未找到公钥 $PUBKEY"
  echo "请先生成密钥: ssh-keygen -t ed25519 -N \"\" -f ~/.ssh/id_ed25519"
  exit 1
fi

echo "将把本机公钥复制到以下服务器（每台会提示输入一次密码）："
for s in "${SERVERS[@]}"; do echo "  - ${USER}@${s}"; done
echo ""

for s in "${SERVERS[@]}"; do
  echo ">>> 配置 ${USER}@${s}"
  if ssh-copy-id -i "$PUBKEY" "${USER}@${s}"; then
    echo ">>> ${s} 配置完成"
  else
    echo ">>> ${s} 失败，请检查网络和用户名/密码"
    exit 1
  fi
  echo ""
done
